<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Excel转JSON工具</title>
  <script src="js/navigation.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 0;
    }

    .page-content {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: calc(100vh - 60px);
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      padding: 40px;
      max-width: 1000px;
      width: 100%;
      text-align: center;
    }

    .header {
      margin-bottom: 30px;
    }



    .title {
      color: #333;
      font-size: 2.5rem;
      margin-bottom: 10px;
      font-weight: 700;
    }

    .subtitle {
      color: #666;
      font-size: 1.1rem;
      margin-bottom: 20px;
    }

    .upload-area {
      border: 3px dashed #667eea;
      border-radius: 15px;
      padding: 40px 20px;
      margin: 20px 0;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .upload-area:hover {
      border-color: #764ba2;
      background-color: #f8f9ff;
    }

    .upload-area.dragover {
      border-color: #764ba2;
      background-color: #f0f4ff;
      transform: scale(1.02);
    }

    .upload-icon {
      font-size: 3rem;
      color: #667eea;
      margin-bottom: 20px;
    }

    .upload-text {
      color: #333;
      font-size: 1.2rem;
      margin-bottom: 10px;
      font-weight: 600;
    }

    .upload-hint {
      color: #999;
      font-size: 0.9rem;
    }

    #fileInput {
      display: none;
    }

    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 25px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 10px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .result-area {
      margin-top: 30px;
      padding: 20px;
      background-color: #f8f9fa;
      border-radius: 10px;
      border-left: 4px solid #667eea;
      display: none;
    }

    .result-title {
      color: #333;
      font-size: 1.3rem;
      margin-bottom: 15px;
      font-weight: 600;
    }

    .json-preview {
      background-color: #2d3748;
      color: #e2e8f0;
      padding: 20px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      max-height: 300px;
      overflow-y: auto;
      text-align: left;
      white-space: pre-wrap;
      word-break: break-all;
    }

    .file-info {
      background-color: #e3f2fd;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
    }

    .file-info-item {
      margin-bottom: 5px;
      margin-right: 20px;
      color: #1976d2;
      font-weight: 500;
      flex-grow: 1;
    }

    .loading {
      display: none;
      color: #667eea;
      font-size: 1.1rem;
      margin-top: 20px;
    }

    .loading::after {
      content: '';
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #667eea;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s linear infinite;
      margin-left: 10px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .success-message {
      background-color: #d4edda;
      color: #155724;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 4px solid #28a745;
    }

    /* 控制选项样式 */
    .control-options {
      margin: 20px 0;
      text-align: left;
      display: flex;
      justify-content: center;
    }

    .checkbox-container {
      display: flex;
      align-items: center;
      cursor: pointer;
      font-size: 16px;
      color: #333;
      user-select: none;
    }

    .checkbox-container input[type="checkbox"] {
      margin-right: 10px;
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .checkbox-container:hover {
      color: #667eea;
    }

    @media (max-width: 768px) {
      .back-btn {
        position: relative;
        top: 0;
        left: 0;
        margin-bottom: 20px;
      }
      
      .title {
        font-size: 2rem;
      }
      
      .container {
        padding: 30px 20px;
      }
    }
  </style>
</head>

<body>
  <div class="page-content">
    <div class="container">
    <div class="header">
      <h1 class="title">📊 Excel转JSON</h1>
      <p class="subtitle">轻松将Excel文件转换为JSON格式数据</p>
    </div>
    
    <div class="loading" id="loading">正在处理文件...</div>

    <div class="result-area" id="resultArea">
      <div class="file-info" id="fileInfo"></div>
      <div class="result-title">JSON数据预览</div>
      <div class="json-preview" id="jsonPreview"></div>
      <button class="btn" id="downloadBtn" onclick="downloadJSON()">
        💾 下载JSON文件
      </button>
      <button class="btn" onclick="resetTool()">
        🔄 重新选择文件
      </button>
    </div>
    
    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
      <div class="upload-icon">📁</div>
      <div class="upload-text">点击选择Excel文件</div>
      <div class="upload-hint">支持 .xls 和 .xlsx 格式</div>
    </div>

    <!-- 控制选项区域 -->
    <div class="control-options">
      <label class="checkbox-container">
        <input type="checkbox" id="removeLineBreaks" checked>
        <span class="checkmark"></span>
        转换时去除换行符（\n\r）
      </label>
    </div>

    <input type="file" id="fileInput" accept=".xls,.xlsx">
  </div>
  
  <script>
    // 全局变量存储处理后的JSON数据和文件信息
    let processedJsonData = null;
    let currentFileName = '';

    // 文件输入监听器
    document.getElementById('fileInput').addEventListener('change', function (event) {
      const file = event.target.files[0];
      if (!file) return;

      // 显示加载状态
      showLoading(true);
      hideResultArea();

      currentFileName = file.name.replace(/\.[^/.]+$/, ""); // 移除文件扩展名
      const reader = new FileReader();

      reader.onload = function (e) {
        try {
          // 解析Excel文件
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const sheetName = workbook.SheetNames[0];
          const sheet = workbook.Sheets[sheetName];
          const jsonResult = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: false });

          // 处理数据转换
          const columns = jsonResult[0]; // 假设第一行包含列名
          let jsonData = [];
          let prevObj = {};

          // 获取是否去除换行符的设置
          const removeLineBreaks = document.getElementById('removeLineBreaks').checked;

          jsonResult.slice(1).forEach((row, index) => {
            const obj = { "column-0": index + 1 };
            columns.forEach((col, i) => {
              let cellValue = row[i];
              
              // 如果启用了去除换行符选项，则处理字符串中的换行符
              if (removeLineBreaks && typeof cellValue === 'string') {
                cellValue = cellValue.replace(/[\n\r]/g, '');
              }
              
              // 检查值是否为日期格式
              if (/^\d{1,2}\/\d{1,2}\/\d{2}$/.test(cellValue)) {
                // 将日期格式转换为 "YYYY年MM月DD日"
                const dateParts = cellValue.split("/");
                const year = parseInt(dateParts[2]);
                const fullYear = year < 50 ? 2000 + year : 1900 + year;
                obj["column-" + (i + 1)] = `${fullYear}年${dateParts[0]}月${dateParts[1]}日`;
              } else {
                obj["column-" + (i + 1)] = cellValue;
              }
            });

            if (obj["column-1"] === undefined) {
              // 如果 column-1 是 undefined，则将 column-3 与前一条非 undefined 的 column-1 合并
              if (obj["column-3"] !== undefined && obj["column-3"] !== 'undefined') {
                prevObj["column-3"] = (prevObj["column-3"] ? prevObj["column-3"] + ", " : "") + obj["column-3"];
              }
            } else {
              // 如果 column-1 不是 undefined，则将对象添加到结果中并更新 prevObj
              jsonData.push(prevObj);
              prevObj = obj;
            }
          });

          // 将最后一个对象添加到结果中
          jsonData.push(prevObj);

          // 如果 column-1 是 undefined，则移除第一个空对象
          if (jsonData[0] && jsonData[0]["column-1"] === undefined) {
            jsonData.shift();
          }

          // 存储处理后的数据
          processedJsonData = jsonData;

          // 显示结果
          displayResults(file, jsonData);

        } catch (error) {
          console.error('文件处理错误:', error);
          alert('文件处理失败，请确保选择的是有效的Excel文件。');
        } finally {
          showLoading(false);
        }
      };

      reader.onerror = function () {
        showLoading(false);
        alert('文件读取失败，请重试。');
      };

      reader.readAsArrayBuffer(file);
    });

    // 显示/隐藏加载状态
    function showLoading(show) {
      const loading = document.getElementById('loading');
      loading.style.display = show ? 'block' : 'none';
    }

    // 隐藏结果区域
    function hideResultArea() {
      const resultArea = document.getElementById('resultArea');
      resultArea.style.display = 'none';
    }

    // 显示处理结果
    function displayResults(file, jsonData) {
      const resultArea = document.getElementById('resultArea');
      const fileInfo = document.getElementById('fileInfo');
      const jsonPreview = document.getElementById('jsonPreview');

      // 显示文件信息
      const fileSize = (file.size / 1024).toFixed(2);
      const recordCount = jsonData.length;

      fileInfo.innerHTML = `
        <div class="file-info-item">文件名: ${file.name}</div>
        <div class="file-info-item">文件大小: ${fileSize} KB</div>
        <div class="file-info-item">数据条数: ${recordCount} 条</div>
      `;

      // 显示JSON预览（限制显示前3条记录）
      const previewData = jsonData.slice(0, 3);
      const jsonString = JSON.stringify(previewData, null, 2);
      const displayText = jsonData.length > 3
        ? jsonString + '\n\n... 还有 ' + (jsonData.length - 3) + ' 条记录'
        : jsonString;

      jsonPreview.textContent = displayText;

      // 显示结果区域
      resultArea.style.display = 'block';

      // 滚动到结果区域
      resultArea.scrollIntoView({ behavior: 'smooth' });
    }

    // 下载JSON文件
    function downloadJSON() {
      if (!processedJsonData) {
        alert('没有可下载的数据，请先选择并处理Excel文件。');
        return;
      }

      try {
        // 获取当前的换行符处理设置
        const removeLineBreaks = document.getElementById('removeLineBreaks').checked;
        let dataToDownload = processedJsonData;
        
        // 如果需要去除换行符，重新处理数据
        if (removeLineBreaks) {
          dataToDownload = JSON.parse(JSON.stringify(processedJsonData)); // 深拷贝
          dataToDownload.forEach(item => {
            Object.keys(item).forEach(key => {
              if (typeof item[key] === 'string') {
                item[key] = item[key].replace(/[\n\r]/g, '');
              }
            });
          });
        }
        
        // 创建JSON字符串
        const jsonString = JSON.stringify(dataToDownload, null, 2);

        // 创建Blob对象
        const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8' });

        // 创建下载链接
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `${currentFileName || 'excel_data'}.json`;

        // 触发下载
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        // 释放URL对象
        URL.revokeObjectURL(url);

        // 显示成功提示
        showDownloadSuccess();

      } catch (error) {
        console.error('下载失败:', error);
        alert('下载失败，请重试。');
      }
    }

    // 显示下载成功提示
    function showDownloadSuccess() {
      const btn = document.getElementById('downloadBtn');
      const originalText = btn.innerHTML;
      btn.innerHTML = '✅ 下载成功';
      btn.disabled = true;

      setTimeout(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
      }, 2000);
    }

    // 重置工具
    function resetTool() {
      // 清空文件输入
      document.getElementById('fileInput').value = '';

      // 清空数据
      processedJsonData = null;
      currentFileName = '';

      // 隐藏结果区域
      hideResultArea();

      // 滚动到顶部
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // 添加拖拽上传功能
    const uploadArea = document.querySelector('.upload-area');

    uploadArea.addEventListener('dragover', function (e) {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', function (e) {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', function (e) {
      e.preventDefault();
      uploadArea.classList.remove('dragover');

      const files = e.dataTransfer.files;
      if (files.length > 0) {
        const file = files[0];
        if (file.name.match(/\.(xls|xlsx)$/i)) {
          document.getElementById('fileInput').files = files;
          document.getElementById('fileInput').dispatchEvent(new Event('change'));
        } else {
          alert('请选择Excel文件（.xls 或 .xlsx 格式）');
        }
      }
    });
  </script>
  <script src="./js/xlsx.full.min.js"></script>
  <script src="js/footer.js"></script>
    </div>
  </div>
</body>

</html>