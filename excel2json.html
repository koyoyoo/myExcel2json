<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Excelè½¬JSONå·¥å…·</title>
  <script src="js/navigation.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 0;
    }

    .page-content {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: calc(100vh - 60px);
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      padding: 40px;
      max-width: 1000px;
      width: 100%;
      text-align: center;
    }

    .header {
      margin-bottom: 30px;
    }



    .title {
      color: #333;
      font-size: 2.5rem;
      margin-bottom: 10px;
      font-weight: 700;
    }

    .subtitle {
      color: #666;
      font-size: 1.1rem;
      margin-bottom: 20px;
    }

    .upload-area {
      border: 3px dashed #667eea;
      border-radius: 15px;
      padding: 40px 20px;
      margin: 20px 0;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .upload-area:hover {
      border-color: #764ba2;
      background-color: #f8f9ff;
    }

    .upload-area.dragover {
      border-color: #764ba2;
      background-color: #f0f4ff;
      transform: scale(1.02);
    }

    .upload-icon {
      font-size: 3rem;
      color: #667eea;
      margin-bottom: 20px;
    }

    .upload-text {
      color: #333;
      font-size: 1.2rem;
      margin-bottom: 10px;
      font-weight: 600;
    }

    .upload-hint {
      color: #999;
      font-size: 0.9rem;
    }

    #fileInput {
      display: none;
    }

    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 25px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 10px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .result-area {
      margin-top: 30px;
      padding: 20px;
      background-color: #f8f9fa;
      border-radius: 10px;
      border-left: 4px solid #667eea;
      display: none;
    }

    .result-title {
      color: #333;
      font-size: 1.3rem;
      margin-bottom: 15px;
      font-weight: 600;
    }

    .json-preview {
      background-color: #2d3748;
      color: #e2e8f0;
      padding: 20px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      max-height: 300px;
      overflow-y: auto;
      text-align: left;
      white-space: pre-wrap;
      word-break: break-all;
    }

    .file-info {
      background-color: #e3f2fd;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
    }

    .file-info-item {
      margin-bottom: 5px;
      margin-right: 20px;
      color: #1976d2;
      font-weight: 500;
      flex-grow: 1;
    }

    .loading {
      display: none;
      color: #667eea;
      font-size: 1.1rem;
      margin-top: 20px;
    }

    .loading::after {
      content: '';
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #667eea;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s linear infinite;
      margin-left: 10px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .success-message {
      background-color: #d4edda;
      color: #155724;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 4px solid #28a745;
    }

    /* æ§åˆ¶é€‰é¡¹æ ·å¼ */
    .control-options {
      margin: 20px 0;
      text-align: left;
      display: flex;
      justify-content: center;
    }

    .checkbox-container {
      display: flex;
      align-items: center;
      cursor: pointer;
      font-size: 16px;
      color: #333;
      user-select: none;
    }

    .checkbox-container input[type="checkbox"] {
      margin-right: 10px;
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .checkbox-container:hover {
      color: #667eea;
    }

    @media (max-width: 768px) {
      .back-btn {
        position: relative;
        top: 0;
        left: 0;
        margin-bottom: 20px;
      }
      
      .title {
        font-size: 2rem;
      }
      
      .container {
        padding: 30px 20px;
      }
    }
  </style>
</head>

<body>
  <div class="page-content">
    <div class="container">
    <div class="header">
      <h1 class="title">ğŸ“Š Excelè½¬JSON</h1>
      <p class="subtitle">è½»æ¾å°†Excelæ–‡ä»¶è½¬æ¢ä¸ºJSONæ ¼å¼æ•°æ®</p>
    </div>
    
    <div class="loading" id="loading">æ­£åœ¨å¤„ç†æ–‡ä»¶...</div>

    <div class="result-area" id="resultArea">
      <div class="file-info" id="fileInfo"></div>
      <div class="result-title">JSONæ•°æ®é¢„è§ˆ</div>
      <div class="json-preview" id="jsonPreview"></div>
      <button class="btn" id="downloadBtn" onclick="downloadJSON()">
        ğŸ’¾ ä¸‹è½½JSONæ–‡ä»¶
      </button>
      <button class="btn" onclick="resetTool()">
        ğŸ”„ é‡æ–°é€‰æ‹©æ–‡ä»¶
      </button>
    </div>
    
    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
      <div class="upload-icon">ğŸ“</div>
      <div class="upload-text">ç‚¹å‡»é€‰æ‹©Excelæ–‡ä»¶</div>
      <div class="upload-hint">æ”¯æŒ .xls å’Œ .xlsx æ ¼å¼</div>
    </div>

    <!-- æ§åˆ¶é€‰é¡¹åŒºåŸŸ -->
    <div class="control-options">
      <label class="checkbox-container">
        <input type="checkbox" id="removeLineBreaks" checked>
        <span class="checkmark"></span>
        è½¬æ¢æ—¶å»é™¤æ¢è¡Œç¬¦ï¼ˆ\n\rï¼‰
      </label>
    </div>

    <input type="file" id="fileInput" accept=".xls,.xlsx">
  </div>
  
  <script>
    // å…¨å±€å˜é‡å­˜å‚¨å¤„ç†åçš„JSONæ•°æ®å’Œæ–‡ä»¶ä¿¡æ¯
    let processedJsonData = null;
    let currentFileName = '';

    // æ–‡ä»¶è¾“å…¥ç›‘å¬å™¨
    document.getElementById('fileInput').addEventListener('change', function (event) {
      const file = event.target.files[0];
      if (!file) return;

      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      showLoading(true);
      hideResultArea();

      currentFileName = file.name.replace(/\.[^/.]+$/, ""); // ç§»é™¤æ–‡ä»¶æ‰©å±•å
      const reader = new FileReader();

      reader.onload = function (e) {
        try {
          // è§£æExcelæ–‡ä»¶
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const sheetName = workbook.SheetNames[0];
          const sheet = workbook.Sheets[sheetName];
          const jsonResult = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: false });

          // å¤„ç†æ•°æ®è½¬æ¢
          const columns = jsonResult[0]; // å‡è®¾ç¬¬ä¸€è¡ŒåŒ…å«åˆ—å
          let jsonData = [];
          let prevObj = {};

          // è·å–æ˜¯å¦å»é™¤æ¢è¡Œç¬¦çš„è®¾ç½®
          const removeLineBreaks = document.getElementById('removeLineBreaks').checked;

          jsonResult.slice(1).forEach((row, index) => {
            const obj = { "column-0": index + 1 };
            columns.forEach((col, i) => {
              let cellValue = row[i];
              
              // å¦‚æœå¯ç”¨äº†å»é™¤æ¢è¡Œç¬¦é€‰é¡¹ï¼Œåˆ™å¤„ç†å­—ç¬¦ä¸²ä¸­çš„æ¢è¡Œç¬¦
              if (removeLineBreaks && typeof cellValue === 'string') {
                cellValue = cellValue.replace(/[\n\r]/g, '');
              }
              
              // æ£€æŸ¥å€¼æ˜¯å¦ä¸ºæ—¥æœŸæ ¼å¼
              if (/^\d{1,2}\/\d{1,2}\/\d{2}$/.test(cellValue)) {
                // å°†æ—¥æœŸæ ¼å¼è½¬æ¢ä¸º "YYYYå¹´MMæœˆDDæ—¥"
                const dateParts = cellValue.split("/");
                const year = parseInt(dateParts[2]);
                const fullYear = year < 50 ? 2000 + year : 1900 + year;
                obj["column-" + (i + 1)] = `${fullYear}å¹´${dateParts[0]}æœˆ${dateParts[1]}æ—¥`;
              } else {
                obj["column-" + (i + 1)] = cellValue;
              }
            });

            if (obj["column-1"] === undefined) {
              // å¦‚æœ column-1 æ˜¯ undefinedï¼Œåˆ™å°† column-3 ä¸å‰ä¸€æ¡é undefined çš„ column-1 åˆå¹¶
              if (obj["column-3"] !== undefined && obj["column-3"] !== 'undefined') {
                prevObj["column-3"] = (prevObj["column-3"] ? prevObj["column-3"] + ", " : "") + obj["column-3"];
              }
            } else {
              // å¦‚æœ column-1 ä¸æ˜¯ undefinedï¼Œåˆ™å°†å¯¹è±¡æ·»åŠ åˆ°ç»“æœä¸­å¹¶æ›´æ–° prevObj
              jsonData.push(prevObj);
              prevObj = obj;
            }
          });

          // å°†æœ€åä¸€ä¸ªå¯¹è±¡æ·»åŠ åˆ°ç»“æœä¸­
          jsonData.push(prevObj);

          // å¦‚æœ column-1 æ˜¯ undefinedï¼Œåˆ™ç§»é™¤ç¬¬ä¸€ä¸ªç©ºå¯¹è±¡
          if (jsonData[0] && jsonData[0]["column-1"] === undefined) {
            jsonData.shift();
          }

          // å­˜å‚¨å¤„ç†åçš„æ•°æ®
          processedJsonData = jsonData;

          // æ˜¾ç¤ºç»“æœ
          displayResults(file, jsonData);

        } catch (error) {
          console.error('æ–‡ä»¶å¤„ç†é”™è¯¯:', error);
          alert('æ–‡ä»¶å¤„ç†å¤±è´¥ï¼Œè¯·ç¡®ä¿é€‰æ‹©çš„æ˜¯æœ‰æ•ˆçš„Excelæ–‡ä»¶ã€‚');
        } finally {
          showLoading(false);
        }
      };

      reader.onerror = function () {
        showLoading(false);
        alert('æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚');
      };

      reader.readAsArrayBuffer(file);
    });

    // æ˜¾ç¤º/éšè—åŠ è½½çŠ¶æ€
    function showLoading(show) {
      const loading = document.getElementById('loading');
      loading.style.display = show ? 'block' : 'none';
    }

    // éšè—ç»“æœåŒºåŸŸ
    function hideResultArea() {
      const resultArea = document.getElementById('resultArea');
      resultArea.style.display = 'none';
    }

    // æ˜¾ç¤ºå¤„ç†ç»“æœ
    function displayResults(file, jsonData) {
      const resultArea = document.getElementById('resultArea');
      const fileInfo = document.getElementById('fileInfo');
      const jsonPreview = document.getElementById('jsonPreview');

      // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
      const fileSize = (file.size / 1024).toFixed(2);
      const recordCount = jsonData.length;

      fileInfo.innerHTML = `
        <div class="file-info-item">æ–‡ä»¶å: ${file.name}</div>
        <div class="file-info-item">æ–‡ä»¶å¤§å°: ${fileSize} KB</div>
        <div class="file-info-item">æ•°æ®æ¡æ•°: ${recordCount} æ¡</div>
      `;

      // æ˜¾ç¤ºJSONé¢„è§ˆï¼ˆé™åˆ¶æ˜¾ç¤ºå‰3æ¡è®°å½•ï¼‰
      const previewData = jsonData.slice(0, 3);
      const jsonString = JSON.stringify(previewData, null, 2);
      const displayText = jsonData.length > 3
        ? jsonString + '\n\n... è¿˜æœ‰ ' + (jsonData.length - 3) + ' æ¡è®°å½•'
        : jsonString;

      jsonPreview.textContent = displayText;

      // æ˜¾ç¤ºç»“æœåŒºåŸŸ
      resultArea.style.display = 'block';

      // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
      resultArea.scrollIntoView({ behavior: 'smooth' });
    }

    // ä¸‹è½½JSONæ–‡ä»¶
    function downloadJSON() {
      if (!processedJsonData) {
        alert('æ²¡æœ‰å¯ä¸‹è½½çš„æ•°æ®ï¼Œè¯·å…ˆé€‰æ‹©å¹¶å¤„ç†Excelæ–‡ä»¶ã€‚');
        return;
      }

      try {
        // è·å–å½“å‰çš„æ¢è¡Œç¬¦å¤„ç†è®¾ç½®
        const removeLineBreaks = document.getElementById('removeLineBreaks').checked;
        let dataToDownload = processedJsonData;
        
        // å¦‚æœéœ€è¦å»é™¤æ¢è¡Œç¬¦ï¼Œé‡æ–°å¤„ç†æ•°æ®
        if (removeLineBreaks) {
          dataToDownload = JSON.parse(JSON.stringify(processedJsonData)); // æ·±æ‹·è´
          dataToDownload.forEach(item => {
            Object.keys(item).forEach(key => {
              if (typeof item[key] === 'string') {
                item[key] = item[key].replace(/[\n\r]/g, '');
              }
            });
          });
        }
        
        // åˆ›å»ºJSONå­—ç¬¦ä¸²
        const jsonString = JSON.stringify(dataToDownload, null, 2);

        // åˆ›å»ºBlobå¯¹è±¡
        const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8' });

        // åˆ›å»ºä¸‹è½½é“¾æ¥
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `${currentFileName || 'excel_data'}.json`;

        // è§¦å‘ä¸‹è½½
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        // é‡Šæ”¾URLå¯¹è±¡
        URL.revokeObjectURL(url);

        // æ˜¾ç¤ºæˆåŠŸæç¤º
        showDownloadSuccess();

      } catch (error) {
        console.error('ä¸‹è½½å¤±è´¥:', error);
        alert('ä¸‹è½½å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚');
      }
    }

    // æ˜¾ç¤ºä¸‹è½½æˆåŠŸæç¤º
    function showDownloadSuccess() {
      const btn = document.getElementById('downloadBtn');
      const originalText = btn.innerHTML;
      btn.innerHTML = 'âœ… ä¸‹è½½æˆåŠŸ';
      btn.disabled = true;

      setTimeout(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
      }, 2000);
    }

    // é‡ç½®å·¥å…·
    function resetTool() {
      // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
      document.getElementById('fileInput').value = '';

      // æ¸…ç©ºæ•°æ®
      processedJsonData = null;
      currentFileName = '';

      // éšè—ç»“æœåŒºåŸŸ
      hideResultArea();

      // æ»šåŠ¨åˆ°é¡¶éƒ¨
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // æ·»åŠ æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½
    const uploadArea = document.querySelector('.upload-area');

    uploadArea.addEventListener('dragover', function (e) {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', function (e) {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', function (e) {
      e.preventDefault();
      uploadArea.classList.remove('dragover');

      const files = e.dataTransfer.files;
      if (files.length > 0) {
        const file = files[0];
        if (file.name.match(/\.(xls|xlsx)$/i)) {
          document.getElementById('fileInput').files = files;
          document.getElementById('fileInput').dispatchEvent(new Event('change'));
        } else {
          alert('è¯·é€‰æ‹©Excelæ–‡ä»¶ï¼ˆ.xls æˆ– .xlsx æ ¼å¼ï¼‰');
        }
      }
    });
  </script>
  <script src="./js/xlsx.full.min.js"></script>
  <script src="js/footer.js"></script>
    </div>
  </div>
</body>

</html>